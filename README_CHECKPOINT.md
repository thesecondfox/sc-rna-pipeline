# æ–­ç‚¹ç»­ä¼ åŠŸèƒ½ - å¿«é€Ÿå¼€å§‹

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

å¢å¼ºç‰ˆå•ç»†èƒRNA-seqåˆ†ææµç¨‹æä¾›äº†å¼ºå¤§çš„**æ–­ç‚¹ç»­ä¼ **åŠŸèƒ½ï¼Œè®©æ‚¨çš„åˆ†ææ›´å¯é ã€æ›´é«˜æ•ˆï¼š

âœ… **è‡ªåŠ¨ä¿å­˜è¿›åº¦** - æ¯ä¸ªæ­¥éª¤å®Œæˆåè‡ªåŠ¨ä¿å­˜
âœ… **æ™ºèƒ½æ¢å¤** - ä»ä¸­æ–­ç‚¹æ— ç¼ç»§ç»­è¿è¡Œ
âœ… **æ•°æ®éªŒè¯** - è‡ªåŠ¨æ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§
âœ… **é”™è¯¯è¿½è¸ª** - è¯¦ç»†çš„é”™è¯¯æ—¥å¿—å’Œè¯Šæ–­
âœ… **äº¤äº’å¼æ“ä½œ** - å‹å¥½çš„ç”¨æˆ·ç•Œé¢å’Œæç¤º

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. é¦–æ¬¡è¿è¡Œ

```bash
python sc_pipeline_enhanced.py \
    --sample_info samples.csv \
    --output_dir ./results \
    --min_genes 500 \
    --integration_method harmony
```

### 2. å¦‚æœä¸­æ–­ï¼Œä»æ–­ç‚¹æ¢å¤

```bash
python sc_pipeline_enhanced.py \
    --sample_info samples.csv \
    --output_dir ./results \
    --resume
```

ç³»ç»Ÿä¼šæ˜¾ç¤ºï¼š
```
æ£€æµ‹åˆ°ä¹‹å‰çš„è¿›åº¦:
================================================================================
âœ… æ­¥éª¤1: æ•°æ®è¯»å– (å·²å®Œæˆ)
âœ… æ­¥éª¤2: è´¨é‡æ§åˆ¶ (å·²å®Œæˆ)
âŒ æ­¥éª¤3: æ•°æ®æ•´åˆ (å¤±è´¥)
â³ æ­¥éª¤4: ç»†èƒæ³¨é‡Š (å¾…æ‰§è¡Œ)
================================================================================

æ˜¯å¦ä»ä¸Šæ¬¡æ–­ç‚¹ç»§ç»­è¿è¡Œï¼Ÿ(y/n):
```

### 3. æŸ¥çœ‹å½“å‰è¿›åº¦

```bash
python sc_pipeline_enhanced.py \
    --sample_info samples.csv \
    --output_dir ./results \
    --show-progress
```

---

## ğŸ“‹ å‘½ä»¤è¡Œå‚æ•°

### æ–­ç‚¹æ§åˆ¶

| å‚æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `--resume` | äº¤äº’å¼æ¢å¤ | `--resume` |
| `--auto-resume` | è‡ªåŠ¨æ¢å¤ï¼ˆæ— éœ€ç¡®è®¤ï¼‰ | `--auto-resume` |
| `--show-progress` | åªæ˜¾ç¤ºè¿›åº¦ï¼Œä¸è¿è¡Œ | `--show-progress` |
| `--reset` | é‡ç½®æ‰€æœ‰æ–­ç‚¹ | `--reset` |

### åˆ†æå‚æ•°

å®Œæ•´å‚æ•°åˆ—è¡¨å‚è§ `--help`ï¼š

```bash
python sc_pipeline_enhanced.py --help
```

---

## ğŸ“Š å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å¼€å§‹åˆ†æ                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   æ£€æŸ¥æ˜¯å¦æœ‰æ–­ç‚¹ï¼Ÿ     â”‚
         â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ æœ‰      â”‚ æ— 
               â–¼         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚æ˜¾ç¤ºè¿›åº¦  â”‚   â”‚ ä»å¤´å¼€å§‹æ‰§è¡Œ  â”‚
         â”‚æç¤ºæ¢å¤  â”‚   â”‚              â”‚
         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚               â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                      â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  æ­¥éª¤1: æ•°æ®è¯»å–  â”‚â”€â”€â”
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                      â–¼            â”‚ æ¯æ­¥å®Œæˆ
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ è‡ªåŠ¨ä¿å­˜
            â”‚  æ­¥éª¤2: è´¨é‡æ§åˆ¶  â”‚  â”‚ æ–­ç‚¹
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                      â–¼            â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
            â”‚  æ­¥éª¤3: æ•°æ®æ•´åˆ  â”‚â—„â”€â”˜
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  æ­¥éª¤4: ç»†èƒæ³¨é‡Š  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   åˆ†æå®Œæˆï¼      â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¡ ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1: å†…å­˜ä¸è¶³

**é—®é¢˜**: åœ¨æ•°æ®æ•´åˆæ­¥éª¤å†…å­˜æº¢å‡º

```bash
# è°ƒæ•´å‚æ•°åç»§ç»­
python sc_pipeline_enhanced.py \
    --sample_info samples.csv \
    --output_dir ./results \
    --gene_num 2000 \
    --n_pcs 30 \
    --resume
```

### åœºæ™¯ 2: å‚æ•°è°ƒä¼˜

**é—®é¢˜**: æƒ³å°è¯•ä¸åŒçš„èšç±»åˆ†è¾¨ç‡

```bash
# åˆ é™¤æ­¥éª¤3çš„è¾“å‡ºï¼Œé‡æ–°è¿è¡Œ
rm ./results/03_integrated_data.h5ad

python sc_pipeline_enhanced.py \
    --sample_info samples.csv \
    --output_dir ./results \
    --resolution 1.2 \
    --resume
```

### åœºæ™¯ 3: æ‰¹å¤„ç†è„šæœ¬

**é—®é¢˜**: éœ€è¦åœ¨æœåŠ¡å™¨ä¸Šæ— äººå€¼å®ˆè¿è¡Œ

```bash
#!/bin/bash
# auto_analysis.sh

python sc_pipeline_enhanced.py \
    --sample_info samples.csv \
    --output_dir ./results \
    --auto-resume \
    --integration_method harmony

# å¦‚æœå¤±è´¥ï¼Œä½¿ç”¨é™çº§å‚æ•°é‡è¯•
if [ $? -ne 0 ]; then
    echo "ä½¿ç”¨é™çº§å‚æ•°é‡è¯•..."
    python sc_pipeline_enhanced.py \
        --sample_info samples.csv \
        --output_dir ./results \
        --auto-resume \
        --gene_num 2000
fi
```

---

## ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶

### æ–­ç‚¹æ–‡ä»¶

```
./results/
â”œâ”€â”€ .checkpoint.json       # æ–­ç‚¹çŠ¶æ€æ–‡ä»¶
â”œâ”€â”€ .error_log.txt        # é”™è¯¯æ—¥å¿—ï¼ˆå¦‚æœ‰ï¼‰
â”œâ”€â”€ 01_raw_data.h5ad      # æ­¥éª¤1è¾“å‡º
â”œâ”€â”€ 02_filtered_data.h5ad # æ­¥éª¤2è¾“å‡º
â”œâ”€â”€ 03_integrated_data.h5ad # æ­¥éª¤3è¾“å‡º
â””â”€â”€ 04_annotated_data.h5ad # æ­¥éª¤4è¾“å‡ºï¼ˆå¯é€‰ï¼‰
```

### æ–­ç‚¹æ–‡ä»¶ç¤ºä¾‹

`.checkpoint.json`:
```json
{
  "step1_read": {
    "completed": true,
    "timestamp": "2025-10-28T10:30:15",
    "valid": true,
    "file": "./results/01_raw_data.h5ad",
    "n_cells": 45230
  }
}
```

---

## ğŸ” è¿›åº¦æŸ¥è¯¢

### å‘½ä»¤è¡ŒæŸ¥è¯¢

```bash
python sc_pipeline_enhanced.py \
    --sample_info samples.csv \
    --output_dir ./results \
    --show-progress
```

### Pythonè„šæœ¬æŸ¥è¯¢

```python
from sc_pipeline_enhanced import CheckpointManager

# åˆ›å»ºç®¡ç†å™¨
ckpt = CheckpointManager("./results")

# æ˜¾ç¤ºè¿›åº¦
ckpt.print_status()

# è·å–æœ€åå®Œæˆçš„æ­¥éª¤
last_step = ckpt.get_last_completed_step()
print(f"æœ€åå®Œæˆ: {last_step}")

# è·å–ä¸‹ä¸€æ­¥
next_step = ckpt.get_next_step()
print(f"ä¸‹ä¸€æ­¥: {next_step}")
```

---

## ğŸ§ª æµ‹è¯•

è¿è¡ŒåŠŸèƒ½æµ‹è¯•ï¼š

```bash
# äº¤äº’å¼æµ‹è¯•
python test_checkpoint.py

# é€‰æ‹©æµ‹è¯•ï¼š
# 1. åŸºæœ¬æ–­ç‚¹ä¿å­˜å’Œæ¢å¤
# 2. å¤±è´¥åæ–­ç‚¹æ¢å¤
# 3. æ–­ç‚¹å®Œæ•´æ€§éªŒè¯
# 4. æ–­ç‚¹é‡ç½®
```

---

## ğŸ“– è¯¦ç»†æ–‡æ¡£

- **[CHECKPOINT_GUIDE.md](CHECKPOINT_GUIDE.md)** - å®Œæ•´ä½¿ç”¨æŒ‡å—
- **[CHANGELOG_CHECKPOINT.md](CHANGELOG_CHECKPOINT.md)** - è¯¦ç»†æ›´æ–°æ—¥å¿—
- **[test_checkpoint.py](test_checkpoint.py)** - æµ‹è¯•è„šæœ¬

---

## ğŸ†š ç‰ˆæœ¬å¯¹æ¯”

| åŠŸèƒ½ | åŸºç¡€ç‰ˆ | å¢å¼ºç‰ˆ |
|------|--------|--------|
| æ–­ç‚¹ä¿å­˜ | âœ… | âœ… |
| æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥ | âŒ | âœ… |
| äº¤äº’å¼æ¢å¤ | âŒ | âœ… |
| è‡ªåŠ¨æ¢å¤ | âŒ | âœ… |
| é”™è¯¯æ—¥å¿— | âŒ | âœ… |
| è¿›åº¦æŸ¥è¯¢ | âŒ | âœ… |
| å¤±è´¥è¿½è¸ª | âŒ | âœ… |
| å‹å¥½æç¤º | âš ï¸ | âœ… |

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. å†…å­˜ç®¡ç†

æŸ¥çœ‹å†…å­˜ä½¿ç”¨æŠ¥å‘Šï¼š
```bash
cat ./results/memory_usage.csv
open ./results/memory_usage.png
```

### 2. å‚æ•°è°ƒä¼˜

å¦‚é‡å†…å­˜é—®é¢˜ï¼Œé™ä½è¿™äº›å‚æ•°ï¼š
- `--gene_num`: 3000 â†’ 2000
- `--n_pcs`: 50 â†’ 30
- `--resolution`: 0.8 â†’ 0.6

### 3. æ‰¹å¤„ç†ä¼˜åŒ–

```bash
# ä½¿ç”¨æ‰€æœ‰CPUæ ¸å¿ƒ
python sc_pipeline_enhanced.py --n_jobs -1 ...

# æˆ–æŒ‡å®šæ ¸å¿ƒæ•°
python sc_pipeline_enhanced.py --n_jobs 8 ...
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: æ–­ç‚¹æ–‡ä»¶æŸå

```bash
# åˆ é™¤æ–­ç‚¹æ–‡ä»¶ï¼Œä½†ä¿ç•™æ•°æ®
rm ./results/.checkpoint.json

# ç³»ç»Ÿä¼šè‡ªåŠ¨é‡å»ºæ–­ç‚¹
python sc_pipeline_enhanced.py --resume ...
```

### é—®é¢˜ 2: æ•°æ®æ–‡ä»¶ä¸¢å¤±

ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹å¹¶æ ‡è®°ä¸ºæ— æ•ˆï¼š
```
âš ï¸ è­¦å‘Š: æ­¥éª¤ step2_qc çš„æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨
```

è§£å†³æ–¹æ¡ˆï¼šè¯¥æ­¥éª¤ä¼šè‡ªåŠ¨é‡æ–°æ‰§è¡Œ

### é—®é¢˜ 3: æŸ¥çœ‹é”™è¯¯è¯¦æƒ…

```bash
# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
cat ./results/.error_log.txt

# æŸ¥çœ‹æ–­ç‚¹çŠ¶æ€
cat ./results/.checkpoint.json | jq
```

---

## ğŸ’¬ å¸¸è§é—®é¢˜

**Q: å¯ä»¥æ‰‹åŠ¨ä¿®æ”¹æ–­ç‚¹å—ï¼Ÿ**

A: å¯ä»¥ã€‚ç¼–è¾‘ `.checkpoint.json` æ–‡ä»¶ï¼Œä¿®æ”¹æˆ–åˆ é™¤ç‰¹å®šæ­¥éª¤çš„æ–­ç‚¹ã€‚

**Q: å¦‚ä½•å¼ºåˆ¶é‡æ–°è¿è¡ŒæŸä¸ªæ­¥éª¤ï¼Ÿ**

A: åˆ é™¤è¯¥æ­¥éª¤çš„è¾“å‡ºæ–‡ä»¶å’Œæ–­ç‚¹è®°å½•ï¼š
```bash
rm ./results/02_filtered_data.h5ad
# ç¼–è¾‘ .checkpoint.jsonï¼Œåˆ é™¤ step2_qc æ¡ç›®
```

**Q: æ–­ç‚¹æ–‡ä»¶å¯ä»¥è·¨ç‰ˆæœ¬ä½¿ç”¨å—ï¼Ÿ**

A: å¢å¼ºç‰ˆå‘åå…¼å®¹åŸºç¡€ç‰ˆçš„æ–­ç‚¹æ–‡ä»¶ã€‚

**Q: æ”¯æŒå¹¶è¡Œè¿è¡Œå¤šä¸ªåˆ†æå—ï¼Ÿ**

A: æ”¯æŒã€‚ä½¿ç”¨ä¸åŒçš„ `--output_dir` å³å¯ï¼š
```bash
python sc_pipeline_enhanced.py --output_dir ./results_v1 ...
python sc_pipeline_enhanced.py --output_dir ./results_v2 ...
```

---

## ğŸ“ è·å–å¸®åŠ©

```bash
# æŸ¥çœ‹æ‰€æœ‰å‚æ•°
python sc_pipeline_enhanced.py --help

# æŸ¥çœ‹å½“å‰ç‰ˆæœ¬
python sc_pipeline_enhanced.py --version
```

---

## ğŸ“ ç¤ºä¾‹å·¥ä½œæµ

### å®Œæ•´ç¤ºä¾‹

```bash
# 1. é¦–æ¬¡è¿è¡Œ
python sc_pipeline_enhanced.py \
    --sample_info samples.csv \
    --output_dir ./results \
    --min_genes 500 \
    --max_genes 8000 \
    --integration_method harmony \
    --run_annotation

# 2. å‡è®¾åœ¨æ­¥éª¤3å¤±è´¥...æŸ¥çœ‹è¿›åº¦
python sc_pipeline_enhanced.py \
    --sample_info samples.csv \
    --output_dir ./results \
    --show-progress

# 3. æŸ¥çœ‹é”™è¯¯æ—¥å¿—
cat ./results/.error_log.txt

# 4. ä¿®å¤é—®é¢˜åç»§ç»­
python sc_pipeline_enhanced.py \
    --sample_info samples.csv \
    --output_dir ./results \
    --resume

# 5. åˆ†æå®Œæˆï¼æŸ¥çœ‹ç»“æœ
ls -lh ./results/
```

---

## ğŸ‰ æ€»ç»“

å¢å¼ºç‰ˆæ–­ç‚¹ç»­ä¼ åŠŸèƒ½è®©æ‚¨ï¼š

- ğŸ’ª **æ›´å¯é ** - ä¸æ€•ä¸­æ–­ï¼Œéšæ—¶æ¢å¤
- âš¡ **æ›´é«˜æ•ˆ** - æ— éœ€é‡å¤è®¡ç®—
- ğŸ” **æ›´é€æ˜** - è¯¦ç»†çš„è¿›åº¦å’Œé”™è¯¯ä¿¡æ¯
- ğŸ˜Š **æ›´å‹å¥½** - æ¸…æ™°çš„æç¤ºå’Œäº¤äº’

**ç«‹å³å¼€å§‹ä½¿ç”¨ï¼**

```bash
python sc_pipeline_enhanced.py \
    --sample_info your_samples.csv \
    --output_dir ./your_results
```

---

**ç‰ˆæœ¬**: 2.2
**æœ€åæ›´æ–°**: 2025-10-28
**ä½œè€…**: Claude Code
