# æ–­ç‚¹ç»­ä¼ åŠŸèƒ½è¯´æ˜

## æ¦‚è¿°

sc-rna-pipeline v2.0 æ”¯æŒ**æµç¨‹æ–­ç‚¹ç»­ä¼ **åŠŸèƒ½ï¼Œå½“åˆ†ææµç¨‹å› ä¸ºæŠ¥é”™ã€ä¸­æ–­æˆ–å…¶ä»–åŸå› åœæ­¢åï¼Œå¯ä»¥ä»ä¸Šæ¬¡ä¸­æ–­çš„åœ°æ–¹ç»§ç»­è¿è¡Œï¼Œæ— éœ€é‡æ–°å¼€å§‹ã€‚

## åŠŸèƒ½ç‰¹æ€§

### 1. è‡ªåŠ¨ä¿å­˜æ–­ç‚¹
- âœ… æ¯ä¸ªä¸»è¦æ­¥éª¤å®Œæˆåè‡ªåŠ¨ä¿å­˜è¿›åº¦
- âœ… ä¿å­˜ä¸­é—´ç»“æœæ–‡ä»¶è·¯å¾„
- âœ… è®°å½•å®Œæˆæ—¶é—´å’Œå…³é”®ç»Ÿè®¡ä¿¡æ¯
- âœ… æ–­ç‚¹æ–‡ä»¶ï¼š`.checkpoint.json`

### 2. æ™ºèƒ½æ¢å¤
- âœ… è‡ªåŠ¨æ£€æµ‹å·²å®Œæˆçš„æ­¥éª¤
- âœ… è·³è¿‡å·²å®Œæˆçš„æ­¥éª¤ï¼Œç›´æ¥åŠ è½½ç»“æœ
- âœ… æ”¯æŒä»ä»»æ„æ–­ç‚¹ç»§ç»­
- âœ… æ”¯æŒå®Œå…¨é‡ç½®ï¼Œä»å¤´å¼€å§‹

### 3. çµæ´»æ§åˆ¶
- âœ… æŸ¥çœ‹å½“å‰è¿›åº¦
- âœ… è·³è¿‡åˆ°æŒ‡å®šæ­¥éª¤
- âœ… æ‰‹åŠ¨é‡ç½®æ–­ç‚¹
- âœ… è‡ªåŠ¨å†…å­˜ç®¡ç†

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

#### 1. æ­£å¸¸è¿è¡Œï¼ˆç¬¬ä¸€æ¬¡ï¼‰

```bash
sc-pipeline \
    --sample_info samples.csv \
    --output_dir ./results \
    --min_genes 500 \
    --max_genes 8000
```

å¦‚æœæµç¨‹ä¸­æ–­ï¼ˆæŠ¥é”™ã€æ‰‹åŠ¨åœæ­¢ç­‰ï¼‰ï¼Œä¼šè‡ªåŠ¨ä¿å­˜æ–­ç‚¹åˆ° `./results/.checkpoint.json`

#### 2. ä»æ–­ç‚¹ç»§ç»­è¿è¡Œ

```bash
sc-pipeline \
    --sample_info samples.csv \
    --output_dir ./results \
    --resume
```

ä½¿ç”¨ `--resume` å‚æ•°ï¼Œæµç¨‹ä¼šï¼š
1. è¯»å–æ–­ç‚¹æ–‡ä»¶
2. æ˜¾ç¤ºå½“å‰è¿›åº¦
3. è·³è¿‡å·²å®Œæˆçš„æ­¥éª¤
4. ä»ä¸­æ–­ç‚¹ç»§ç»­è¿è¡Œ

#### 3. æŸ¥çœ‹å½“å‰è¿›åº¦

```bash
sc-pipeline \
    --sample_info samples.csv \
    --output_dir ./results \
    --show-progress
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
================================================================================
å½“å‰åˆ†æè¿›åº¦
================================================================================
âœ… æ­¥éª¤1: æ•°æ®è¯»å–
   å®Œæˆæ—¶é—´: 2025-01-15 10:30:45
   æ–‡ä»¶: 01_raw_data.h5ad (1250.3 MB)
âœ… æ­¥éª¤2: è´¨é‡æ§åˆ¶
   å®Œæˆæ—¶é—´: 2025-01-15 10:45:20
   æ–‡ä»¶: 02_filtered_data.h5ad (980.5 MB)
â³ æ­¥éª¤3: æ•°æ®æ•´åˆ
â³ æ­¥éª¤4: ç»†èƒæ³¨é‡Š
================================================================================
```

#### 4. é‡ç½®æ‰€æœ‰æ–­ç‚¹ï¼Œä»å¤´å¼€å§‹

```bash
sc-pipeline \
    --sample_info samples.csv \
    --output_dir ./results \
    --reset
```

è¿™ä¼šåˆ é™¤æ–­ç‚¹æ–‡ä»¶ï¼Œä»ç¬¬ä¸€æ­¥é‡æ–°å¼€å§‹ã€‚

#### 5. è·³è¿‡åˆ°æŒ‡å®šæ­¥éª¤

```bash
# è·³è¿‡åˆ°è´¨æ§æ­¥éª¤
sc-pipeline \
    --sample_info samples.csv \
    --output_dir ./results \
    --skip-to qc

# è·³è¿‡åˆ°æ•´åˆæ­¥éª¤
sc-pipeline \
    --sample_info samples.csv \
    --output_dir ./results \
    --skip-to integrate

# è·³è¿‡åˆ°æ³¨é‡Šæ­¥éª¤
sc-pipeline \
    --sample_info samples.csv \
    --output_dir ./results \
    --skip-to annotate
```

## å·¥ä½œæµç¨‹ç¤ºä¾‹

### åœºæ™¯1ï¼šæµç¨‹åœ¨è´¨æ§æ­¥éª¤æŠ¥é”™

```bash
# ç¬¬ä¸€æ¬¡è¿è¡Œ
$ sc-pipeline --sample_info samples.csv --output_dir ./results

# è¾“å‡ºï¼š
ğŸ”¹ğŸ”¹ğŸ”¹... æ­¥éª¤ 1/4: è¯»å–æ ·å“æ•°æ®
âœ… è¯»å–å®Œæˆ
   ğŸ’¾ æ–­ç‚¹å·²ä¿å­˜: step1_read

ğŸ”¹ğŸ”¹ğŸ”¹... æ­¥éª¤ 2/4: è´¨é‡æ§åˆ¶
âŒ è´¨æ§å¤±è´¥: XXXé”™è¯¯

# ä¿®å¤é—®é¢˜åï¼Œä»æ–­ç‚¹ç»§ç»­
$ sc-pipeline --sample_info samples.csv --output_dir ./results --resume

# è¾“å‡ºï¼š
================================================================================
å½“å‰åˆ†æè¿›åº¦
================================================================================
âœ… æ­¥éª¤1: æ•°æ®è¯»å–
â³ æ­¥éª¤2: è´¨é‡æ§åˆ¶
â³ æ­¥éª¤3: æ•°æ®æ•´åˆ
â³ æ­¥éª¤4: ç»†èƒæ³¨é‡Š
================================================================================
ğŸ”„ ä»ä¸Šæ¬¡æ–­ç‚¹ç»§ç»­è¿è¡Œ...

âœ“ æ­¥éª¤1å·²å®Œæˆï¼ŒåŠ è½½å·²æœ‰æ•°æ®...
  ç»†èƒæ•°: 50,000

ğŸ”¹ğŸ”¹ğŸ”¹... æ­¥éª¤ 2/4: è´¨é‡æ§åˆ¶
# ç»§ç»­è¿è¡Œè´¨æ§...
```

### åœºæ™¯2ï¼šæ‰‹åŠ¨ä¸­æ–­åç»§ç»­

```bash
# è¿è¡Œä¸­æŒ‰ Ctrl+C ä¸­æ–­
$ sc-pipeline --sample_info samples.csv --output_dir ./results
^C

# æŸ¥çœ‹è¿›åº¦
$ sc-pipeline --sample_info samples.csv --output_dir ./results --show-progress
âœ… æ­¥éª¤1: æ•°æ®è¯»å–
âœ… æ­¥éª¤2: è´¨é‡æ§åˆ¶
â³ æ­¥éª¤3: æ•°æ®æ•´åˆ

# ç»§ç»­è¿è¡Œ
$ sc-pipeline --sample_info samples.csv --output_dir ./results --resume
```

### åœºæ™¯3ï¼šä¿®æ”¹å‚æ•°åé‡æ–°è¿è¡Œ

```bash
# ç¬¬ä¸€æ¬¡è¿è¡Œï¼Œå‘ç°å‚æ•°ä¸åˆé€‚
$ sc-pipeline \
    --sample_info samples.csv \
    --output_dir ./results \
    --min_genes 200  # å¤ªå®½æ¾

# é‡ç½®æ–­ç‚¹ï¼Œä½¿ç”¨æ–°å‚æ•°é‡æ–°è¿è¡Œ
$ sc-pipeline \
    --sample_info samples.csv \
    --output_dir ./results \
    --min_genes 500 \  # æ›´ä¸¥æ ¼
    --reset
```

## æ–­ç‚¹æ–‡ä»¶ç»“æ„

`.checkpoint.json` ç¤ºä¾‹ï¼š

```json
{
  "step1_read": {
    "completed": true,
    "timestamp": "2025-01-15T10:30:45.123456",
    "file": "./results/01_raw_data.h5ad",
    "n_cells": 50000,
    "n_genes": 30000
  },
  "step2_qc": {
    "completed": true,
    "timestamp": "2025-01-15T10:45:20.654321",
    "file": "./results/02_filtered_data.h5ad",
    "n_cells_after": 45000
  },
  "step3_integrate": {
    "completed": false
  }
}
```

## Python API ä½¿ç”¨

```python
from sc_pipeline import CheckpointManager, MemoryMonitor
from sc_pipeline.io import read_sample
from sc_pipeline.preprocessing import quality_control

# åˆå§‹åŒ–æ–­ç‚¹ç®¡ç†å™¨
ckpt = CheckpointManager('./results')

# æŸ¥çœ‹è¿›åº¦
ckpt.print_status()

# æ­¥éª¤1ï¼šè¯»å–æ•°æ®
if not ckpt.is_completed('step1_read'):
    adata = read_sample('samples.csv')
    adata.write('./results/01_raw_data.h5ad')
    ckpt.save_checkpoint('step1_read',
                        file='./results/01_raw_data.h5ad',
                        n_cells=adata.n_obs)
else:
    print("æ­¥éª¤1å·²å®Œæˆï¼ŒåŠ è½½æ•°æ®...")
    adata = sc.read_h5ad('./results/01_raw_data.h5ad')

# æ­¥éª¤2ï¼šè´¨æ§
if not ckpt.is_completed('step2_qc'):
    adata_filtered, qc_stats = quality_control(adata)
    adata_filtered.write('./results/02_filtered_data.h5ad')
    ckpt.save_checkpoint('step2_qc',
                        file='./results/02_filtered_data.h5ad')
else:
    print("æ­¥éª¤2å·²å®Œæˆï¼ŒåŠ è½½æ•°æ®...")
    adata_filtered = sc.read_h5ad('./results/02_filtered_data.h5ad')

# è·å–è¿›åº¦ç™¾åˆ†æ¯”
progress = ckpt.get_progress_percentage()
print(f"å®Œæˆè¿›åº¦: {progress}%")
```

## å†…å­˜ç›‘æ§

æ–­ç‚¹ç»­ä¼ åŠŸèƒ½ä¸å†…å­˜ç›‘æ§å®Œå…¨é›†æˆï¼š

```bash
# ç”Ÿæˆå†…å­˜ä½¿ç”¨æŠ¥å‘Š
$ sc-pipeline \
    --sample_info samples.csv \
    --output_dir ./results \
    --resume
```

å®Œæˆåä¼šç”Ÿæˆï¼š
- `memory_usage.csv` - å†…å­˜ä½¿ç”¨è¯¦ç»†æŠ¥å‘Š
- `memory_usage.png` - å†…å­˜ä½¿ç”¨è¶‹åŠ¿å›¾

## æ³¨æ„äº‹é¡¹

### 1. æ–‡ä»¶å®Œæ•´æ€§
- ç¡®ä¿ä¸­é—´ç»“æœæ–‡ä»¶æ²¡æœ‰è¢«åˆ é™¤
- å¦‚æœæ–‡ä»¶æŸåï¼Œä½¿ç”¨ `--reset` é‡æ–°è¿è¡Œ

### 2. å‚æ•°ä¸€è‡´æ€§
- ç»§ç»­è¿è¡Œæ—¶åº”ä½¿ç”¨ç›¸åŒçš„å‚æ•°
- å¦‚æœéœ€è¦ä¿®æ”¹å‚æ•°ï¼Œå»ºè®®ä½¿ç”¨ `--reset`

### 3. æ–­ç‚¹æ–‡ä»¶ç®¡ç†
- æ–­ç‚¹æ–‡ä»¶ä¿å­˜åœ¨è¾“å‡ºç›®å½•ï¼š`{output_dir}/.checkpoint.json`
- åˆ é™¤æ–­ç‚¹æ–‡ä»¶ç­‰åŒäº `--reset`
- ä¸åŒçš„è¾“å‡ºç›®å½•æœ‰ç‹¬ç«‹çš„æ–­ç‚¹

### 4. ç£ç›˜ç©ºé—´
- ä¸­é—´ç»“æœæ–‡ä»¶ä¼šå ç”¨ç£ç›˜ç©ºé—´
- å®Œæˆåå¯ä»¥åˆ é™¤ä¸éœ€è¦çš„ä¸­é—´æ–‡ä»¶
- å»ºè®®ä¿ç•™æœ€ç»ˆçš„æ•´åˆæ•°æ®

## å¸¸è§é—®é¢˜

### Q: æ–­ç‚¹æ–‡ä»¶åœ¨å“ªé‡Œï¼Ÿ
**A:** åœ¨è¾“å‡ºç›®å½•ä¸‹çš„ `.checkpoint.json` æ–‡ä»¶

### Q: å¦‚ä½•å®Œå…¨é‡æ–°è¿è¡Œï¼Ÿ
**A:** ä½¿ç”¨ `--reset` å‚æ•°ï¼Œæˆ–åˆ é™¤ `.checkpoint.json` æ–‡ä»¶

### Q: ä¿®æ”¹äº†å‚æ•°åèƒ½ç»§ç»­è¿è¡Œå—ï¼Ÿ
**A:** å¯ä»¥ï¼Œä½†å»ºè®®ä½¿ç”¨ `--reset` é‡æ–°è¿è¡Œä»¥ä¿è¯ä¸€è‡´æ€§

### Q: æ–­ç‚¹ç»­ä¼ ä¼šè·³è¿‡å“ªäº›æ­¥éª¤ï¼Ÿ
**A:** åªè·³è¿‡å·²å®Œæˆçš„å®Œæ•´æ­¥éª¤ï¼Œä¸ä¼šè·³è¿‡éƒ¨åˆ†å®Œæˆçš„æ­¥éª¤

### Q: å¦‚æœä¸­é—´æ–‡ä»¶è¢«åˆ é™¤äº†æ€ä¹ˆåŠï¼Ÿ
**A:** ä½¿ç”¨ `--reset` é‡æ–°è¿è¡Œï¼Œæˆ–æ‰‹åŠ¨ç¼–è¾‘ `.checkpoint.json` åˆ é™¤å¯¹åº”çš„æ­¥éª¤è®°å½•

### Q: å¯ä»¥åœ¨ä¸åŒæœºå™¨ä¸Šç»§ç»­è¿è¡Œå—ï¼Ÿ
**A:** éœ€è¦åŒæ—¶å¤åˆ¶è¾“å‡ºç›®å½•å’Œä¸­é—´ç»“æœæ–‡ä»¶

## ä¸æ—§ç‰ˆæœ¬çš„å…¼å®¹æ€§

å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ v1.0 ç‰ˆæœ¬ï¼Œå‡çº§åˆ° v2.0 åï¼š
1. æ—§çš„å‘½ä»¤è¡Œå‚æ•°å®Œå…¨å…¼å®¹
2. æ–°å¢çš„æ–­ç‚¹åŠŸèƒ½æ˜¯å¯é€‰çš„ï¼ˆä¸ä½¿ç”¨ `--resume` æ—¶è¡Œä¸ºä¸æ—§ç‰ˆæœ¬ç›¸åŒï¼‰
3. å¯ä»¥å®‰å…¨å‡çº§ï¼Œä¸å½±å“ç°æœ‰å·¥ä½œæµ

## æŠ€æœ¯å®ç°

æ–­ç‚¹ç»­ä¼ åŸºäºä»¥ä¸‹è®¾è®¡ï¼š
1. **CheckpointManager ç±»**ï¼šç®¡ç†æ–­ç‚¹çŠ¶æ€
2. **JSON æŒä¹…åŒ–**ï¼šæ–­ç‚¹ä¿¡æ¯ä¿å­˜ä¸º JSON æ–‡ä»¶
3. **æ­¥éª¤æ ‡è¯†**ï¼šæ¯ä¸ªä¸»è¦æ­¥éª¤æœ‰å”¯ä¸€æ ‡è¯†ç¬¦
4. **æ–‡ä»¶éªŒè¯**ï¼šæ£€æŸ¥ä¸­é—´æ–‡ä»¶æ˜¯å¦å­˜åœ¨
5. **å¼‚å¸¸å¤„ç†**ï¼šæ•è·é”™è¯¯å¹¶ä¿æŒæ–­ç‚¹å®Œæ•´æ€§

## æ›´å¤šä¿¡æ¯

- å®Œæ•´æ–‡æ¡£: [docs/](docs/)
- ä½¿ç”¨ç¤ºä¾‹: [USAGE_EXAMPLES.md](USAGE_EXAMPLES.md)
- æ¨¡å—åŒ–è¯´æ˜: [MODULARIZATION.md](MODULARIZATION.md)
