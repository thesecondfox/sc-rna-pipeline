# æ–­ç‚¹ç»­ä¼ åŠŸèƒ½æ›´æ–°æ—¥å¿—

## ç‰ˆæœ¬ 2.2 - å¢å¼ºç‰ˆæ–­ç‚¹ç»­ä¼  (2025-10-28)

### ä¸»è¦æ”¹è¿›

#### 1. **å¢å¼ºçš„CheckpointManagerç±»**

æ–°å¢åŠŸèƒ½ï¼š
- âœ… **æ•°æ®å®Œæ•´æ€§éªŒè¯**: è‡ªåŠ¨æ£€æŸ¥ä¿å­˜çš„æ•°æ®æ–‡ä»¶æ˜¯å¦å­˜åœ¨å’Œå®Œæ•´
- âœ… **æ–‡ä»¶å¤§å°æ ¡éªŒ**: è®°å½•å¹¶éªŒè¯æ–‡ä»¶å¤§å°ï¼Œæ£€æµ‹æŸåçš„æ•°æ®
- âœ… **æ™ºèƒ½æ¢å¤åˆ¤æ–­**: è‡ªåŠ¨è¯†åˆ«æœ‰æ•ˆå’Œæ— æ•ˆçš„æ–­ç‚¹
- âœ… **è¯¦ç»†è¿›åº¦æ˜¾ç¤º**: å±•ç¤ºæ¯ä¸ªæ­¥éª¤çš„å®ŒæˆçŠ¶æ€ã€æ—¶é—´å’Œå…³é”®ç»Ÿè®¡

#### 2. **å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶**

æ–°å¢åŠŸèƒ½ï¼š
- âœ… **å¼‚å¸¸æ•è·å’Œè®°å½•**: æ•è·æ‰€æœ‰é”™è¯¯å¹¶ä¿å­˜è¯¦ç»†è¿½è¸ªä¿¡æ¯
- âœ… **é”™è¯¯æ—¥å¿—æ–‡ä»¶**: ç‹¬ç«‹çš„ `.error_log.txt` è®°å½•æ‰€æœ‰é”™è¯¯
- âœ… **å¤±è´¥æ­¥éª¤æ ‡è®°**: åœ¨æ–­ç‚¹æ–‡ä»¶ä¸­æ ‡è®°å¤±è´¥çš„æ­¥éª¤
- âœ… **å®‰å…¨æ‰§è¡ŒåŒ…è£…å™¨**: `safe_step_execution()` å‡½æ•°ç»Ÿä¸€å¤„ç†é”™è¯¯

#### 3. **äº¤äº’å¼æ¢å¤åŠŸèƒ½**

æ–°å¢åŠŸèƒ½ï¼š
- âœ… **æ™ºèƒ½æ¢å¤æç¤º**: æ£€æµ‹åˆ°æ–­ç‚¹æ—¶è‡ªåŠ¨æç¤ºç”¨æˆ·
- âœ… **è¿›åº¦é¢„è§ˆ**: æ¢å¤å‰æ˜¾ç¤ºè¯¦ç»†çš„å½“å‰è¿›åº¦
- âœ… **ç”¨æˆ·ç¡®è®¤æœºåˆ¶**: äº¤äº’å¼ç¡®è®¤æ˜¯å¦ä»æ–­ç‚¹ç»§ç»­
- âœ… **è‡ªåŠ¨æ¢å¤æ¨¡å¼**: `--auto-resume` å‚æ•°æ”¯æŒæ— äººå€¼å®ˆè¿è¡Œ

#### 4. **æ–°å¢å‘½ä»¤è¡Œå‚æ•°**

```bash
--resume           # ä»æ–­ç‚¹æ¢å¤ï¼ˆäº¤äº’å¼ï¼‰
--auto-resume      # è‡ªåŠ¨ä»æ–­ç‚¹æ¢å¤ï¼ˆæ— éœ€ç¡®è®¤ï¼‰
--reset            # é‡ç½®æ‰€æœ‰æ–­ç‚¹ï¼Œä»å¤´å¼€å§‹
--show-progress    # æŸ¥çœ‹å½“å‰è¿›åº¦ï¼ˆä¸è¿è¡Œï¼‰
```

### æŠ€æœ¯å®ç°

#### CheckpointManager æ ¸å¿ƒæ–¹æ³•

```python
# æ•°æ®å®Œæ•´æ€§éªŒè¯
def _validate_checkpoints(checkpoints):
    """æ£€æŸ¥æ–‡ä»¶å­˜åœ¨æ€§å’Œå¤§å°"""

# å¢å¼ºçš„æ–­ç‚¹ä¿å­˜
def save_checkpoint(step, **kwargs):
    """è‡ªåŠ¨è®°å½•æ–‡ä»¶å¤§å°å’Œæ—¶é—´æˆ³"""

# å¤±è´¥æ ‡è®°
def mark_step_failed(step, error):
    """è®°å½•é”™è¯¯ä¿¡æ¯åˆ°æ–­ç‚¹å’Œæ—¥å¿—æ–‡ä»¶"""

# æ™ºèƒ½æ¢å¤åˆ¤æ–­
def should_resume():
    """äº¤äº’å¼æˆ–è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦æ¢å¤"""

# è¿›åº¦æŸ¥è¯¢
def get_last_completed_step():
    """è·å–æœ€åå®Œæˆçš„æ­¥éª¤"""

def get_next_step():
    """è·å–ä¸‹ä¸€ä¸ªå¾…æ‰§è¡Œæ­¥éª¤"""
```

#### å®‰å…¨æ‰§è¡ŒåŒ…è£…å™¨

```python
def safe_step_execution(checkpoint_manager, step_name, func, *args, **kwargs):
    """
    ç»Ÿä¸€çš„æ­¥éª¤æ‰§è¡ŒåŒ…è£…å™¨

    åŠŸèƒ½ï¼š
    - æ•è·æ‰€æœ‰å¼‚å¸¸ï¼ˆåŒ…æ‹¬KeyboardInterruptï¼‰
    - è‡ªåŠ¨è®°å½•é”™è¯¯åˆ°æ–­ç‚¹ç®¡ç†å™¨
    - æ‰“å°è¯¦ç»†çš„é”™è¯¯è¿½è¸ªä¿¡æ¯
    - å‹å¥½çš„é”™è¯¯æç¤º
    """
```

### æ–­ç‚¹æ–‡ä»¶æ ¼å¼

#### .checkpoint.json ç»“æ„

```json
{
  "step1_read": {
    "completed": true,
    "timestamp": "2025-10-28T10:30:15.123456",
    "valid": true,
    "file": "./results/01_raw_data.h5ad",
    "file_size": 1311551488,
    "n_cells": 45230,
    "n_genes": 33538
  },
  "step2_qc": {
    "completed": true,
    "timestamp": "2025-10-28T10:45:22.789012",
    "valid": true,
    "file": "./results/02_filtered_data.h5ad",
    "file_size": 1027995648,
    "n_cells_after": 38567
  },
  "step3_integrate": {
    "failed": true,
    "timestamp": "2025-10-28T10:50:18.456789",
    "error_type": "MemoryError",
    "error_message": "Unable to allocate array",
    "traceback": "Traceback (most recent call last):\n..."
  }
}
```

#### .error_log.txt æ ¼å¼

```
================================================================================
æ­¥éª¤: step3_integrate
æ—¶é—´: 2025-10-28T10:50:18.456789
é”™è¯¯ç±»å‹: MemoryError
é”™è¯¯ä¿¡æ¯: Unable to allocate array with shape (50000, 3000) and data type float64
è¯¦ç»†è¿½è¸ª:
Traceback (most recent call last):
  File "sc_pipeline_enhanced.py", line 1250, in integration_step
    sc.pp.scale(adata, max_value=10)
  ...
MemoryError: Unable to allocate array with shape (50000, 3000) and data type float64
```

### ä½¿ç”¨ç¤ºä¾‹

#### ç¤ºä¾‹ 1: æ­£å¸¸è¿è¡Œå¹¶ä¸­æ–­

```bash
# é¦–æ¬¡è¿è¡Œ
python sc_pipeline_enhanced.py \
    --sample_info samples.csv \
    --output_dir ./results

# å‡è®¾åœ¨æ­¥éª¤2å¤±è´¥...

# ä¿®å¤é—®é¢˜åç»§ç»­
python sc_pipeline_enhanced.py \
    --sample_info samples.csv \
    --output_dir ./results \
    --resume
```

è¾“å‡º:
```
æ£€æµ‹åˆ°ä¹‹å‰çš„è¿›åº¦:
================================================================================
å½“å‰åˆ†æè¿›åº¦
================================================================================
âœ… æ­¥éª¤1: æ•°æ®è¯»å–
   å®Œæˆæ—¶é—´: 2025-10-28 10:30:15
   æ–‡ä»¶: 01_raw_data.h5ad (1250.5 MB)
   ç»†èƒæ•°: 45,230

âŒ æ­¥éª¤2: è´¨é‡æ§åˆ¶ - å¤±è´¥
   é”™è¯¯: Invalid sample path
   æ—¶é—´: 2025-10-28 10:35:20

â³ æ­¥éª¤3: æ•°æ®æ•´åˆ - å¾…æ‰§è¡Œ
â³ æ­¥éª¤4: ç»†èƒæ³¨é‡Š - å¾…æ‰§è¡Œ
================================================================================

æ˜¯å¦ä»ä¸Šæ¬¡æ–­ç‚¹ç»§ç»­è¿è¡Œï¼Ÿ(y/n): y

ğŸ”„ ä»æ–­ç‚¹æ¢å¤ï¼Œè·³è¿‡å·²å®Œæˆçš„æ­¥éª¤...
```

#### ç¤ºä¾‹ 2: è‡ªåŠ¨æ¢å¤ï¼ˆç”¨äºè„šæœ¬ï¼‰

```bash
#!/bin/bash
# è‡ªåŠ¨åŒ–åˆ†æè„šæœ¬

python sc_pipeline_enhanced.py \
    --sample_info samples.csv \
    --output_dir ./results \
    --auto-resume \
    --min_genes 500 \
    --integration_method harmony

# å¦‚æœå¤±è´¥ï¼Œè°ƒæ•´å‚æ•°åé‡è¯•
if [ $? -ne 0 ]; then
    echo "å°è¯•é™ä½å‚æ•°é‡æ–°è¿è¡Œ..."
    python sc_pipeline_enhanced.py \
        --sample_info samples.csv \
        --output_dir ./results \
        --auto-resume \
        --gene_num 2000 \
        --n_pcs 30
fi
```

#### ç¤ºä¾‹ 3: æŸ¥çœ‹è¿›åº¦

```bash
python sc_pipeline_enhanced.py \
    --sample_info samples.csv \
    --output_dir ./results \
    --show-progress
```

è¾“å‡º:
```
================================================================================
å½“å‰åˆ†æè¿›åº¦
================================================================================
âœ… æ­¥éª¤1: æ•°æ®è¯»å–
   å®Œæˆæ—¶é—´: 2025-10-28 10:30:15
   æ–‡ä»¶: 01_raw_data.h5ad (1250.5 MB)
   ç»†èƒæ•°: 45,230
   åŸºå› æ•°: 33,538

âœ… æ­¥éª¤2: è´¨é‡æ§åˆ¶
   å®Œæˆæ—¶é—´: 2025-10-28 10:45:22
   æ–‡ä»¶: 02_filtered_data.h5ad (980.3 MB)
   ç»†èƒæ•°: 38,567

âœ… æ­¥éª¤3: æ•°æ®æ•´åˆ
   å®Œæˆæ—¶é—´: 2025-10-28 11:05:18
   æ–‡ä»¶: 03_integrated_data.h5ad (850.7 MB)
   ç»†èƒæ•°: 38,567
   èšç±»æ•°: 15

â³ æ­¥éª¤4: ç»†èƒæ³¨é‡Š - å¾…æ‰§è¡Œ
================================================================================

ğŸ“ ä¸‹ä¸€æ­¥: æ­¥éª¤4: ç»†èƒæ³¨é‡Š
```

### ä¼˜åŠ¿å¯¹æ¯”

| åŠŸèƒ½ | åŸç‰ˆæœ¬ | å¢å¼ºç‰ˆæœ¬ |
|------|--------|---------|
| æ–­ç‚¹ä¿å­˜ | âœ… | âœ… |
| æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥ | âŒ | âœ… |
| é”™è¯¯è¯¦ç»†è®°å½• | âŒ | âœ… |
| äº¤äº’å¼æ¢å¤ | âŒ | âœ… |
| è‡ªåŠ¨æ¢å¤æ¨¡å¼ | âŒ | âœ… |
| è¿›åº¦æŸ¥çœ‹ | âŒ | âœ… |
| å¤±è´¥æ­¥éª¤æ ‡è®° | âŒ | âœ… |
| é”™è¯¯æ—¥å¿—æ–‡ä»¶ | âŒ | âœ… |
| ç”¨æˆ·å‹å¥½æç¤º | âš ï¸ | âœ… |

### é”™è¯¯æ¢å¤åœºæ™¯

#### åœºæ™¯ 1: å†…å­˜ä¸è¶³

**é—®é¢˜**: æ­¥éª¤3å› å†…å­˜ä¸è¶³å¤±è´¥

**æ£€æµ‹**:
```
âŒ æ­¥éª¤3: æ•°æ®æ•´åˆ - å¤±è´¥
   é”™è¯¯: MemoryError: Unable to allocate array
```

**è§£å†³**:
```bash
# é™ä½å‚æ•°åç»§ç»­
python sc_pipeline_enhanced.py \
    --sample_info samples.csv \
    --output_dir ./results \
    --gene_num 2000 \
    --n_pcs 30 \
    --resume
```

#### åœºæ™¯ 2: æ•°æ®æ–‡ä»¶æŸå

**é—®é¢˜**: æ–­ç‚¹æ–‡ä»¶å­˜åœ¨ä½†æ•°æ®æ–‡ä»¶è¢«åˆ é™¤

**æ£€æµ‹**:
```
âš ï¸  è­¦å‘Š: æ­¥éª¤ step2_qc çš„æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨: ./results/02_filtered_data.h5ad
```

**è§£å†³**: ç³»ç»Ÿè‡ªåŠ¨æ ‡è®°ä¸ºæ— æ•ˆï¼Œé‡æ–°æ‰§è¡Œè¯¥æ­¥éª¤

#### åœºæ™¯ 3: å‚æ•°è°ƒæ•´

**é—®é¢˜**: éœ€è¦è°ƒæ•´è´¨æ§å‚æ•°

**è§£å†³**:
```bash
# åˆ é™¤æ­¥éª¤2çš„è¾“å‡º
rm ./results/02_filtered_data.h5ad

# æ‰‹åŠ¨ç¼–è¾‘æ–­ç‚¹æ–‡ä»¶ï¼Œæˆ–ç›´æ¥ä½¿ç”¨ --reset é‡æ–°å¼€å§‹æŒ‡å®šæ­¥éª¤
python sc_pipeline_enhanced.py \
    --sample_info samples.csv \
    --output_dir ./results \
    --min_genes 300 \
    --max_pct_mito 20 \
    --resume
```

### æµ‹è¯•

æä¾›äº†å®Œæ•´çš„æµ‹è¯•è„šæœ¬ `test_checkpoint.py`:

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
python test_checkpoint.py

# æµ‹è¯•å†…å®¹ï¼š
# 1. åŸºæœ¬æ–­ç‚¹ä¿å­˜å’Œæ¢å¤
# 2. å¤±è´¥åæ–­ç‚¹æ¢å¤
# 3. æ–­ç‚¹å®Œæ•´æ€§éªŒè¯
# 4. æ–­ç‚¹é‡ç½®
```

### æ–‡æ¡£

æ–°å¢æ–‡æ¡£æ–‡ä»¶ï¼š
- `CHECKPOINT_GUIDE.md`: è¯¦ç»†çš„ä½¿ç”¨æŒ‡å—
- `CHANGELOG_CHECKPOINT.md`: æœ¬æ›´æ–°æ—¥å¿—
- `test_checkpoint.py`: åŠŸèƒ½æµ‹è¯•è„šæœ¬

### å‘åå…¼å®¹æ€§

âœ… **å®Œå…¨å…¼å®¹**: å¢å¼ºç‰ˆå®Œå…¨å…¼å®¹åŸæœ‰çš„å‘½ä»¤è¡Œå‚æ•°å’Œå·¥ä½œæµç¨‹
- ä¸ä½¿ç”¨æ–°å‚æ•°æ—¶ï¼Œè¡Œä¸ºä¸åŸç‰ˆæœ¬ä¸€è‡´
- åŸæœ‰çš„æ–­ç‚¹æ–‡ä»¶æ ¼å¼ä»ç„¶æ”¯æŒ
- å¯ä»¥æ— ç¼å‡çº§

### æœªæ¥è®¡åˆ’

å¯èƒ½çš„è¿›ä¸€æ­¥æ”¹è¿›ï¼š
- [ ] æ”¯æŒå¹¶è¡Œæ­¥éª¤çš„æ–­ç‚¹ç®¡ç†
- [ ] æ·»åŠ æ–­ç‚¹çš„ç‰ˆæœ¬æ§åˆ¶
- [ ] æ”¯æŒè¿œç¨‹æ–­ç‚¹åŒæ­¥
- [ ] æä¾›Webç•Œé¢æŸ¥çœ‹è¿›åº¦
- [ ] è‡ªåŠ¨æ€§èƒ½ä¼˜åŒ–å»ºè®®

### åé¦ˆå’Œè´¡çŒ®

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤Issueæˆ–Pull Requestã€‚

---

**ç‰ˆæœ¬**: 2.2
**å‘å¸ƒæ—¥æœŸ**: 2025-10-28
**ä½œè€…**: Claude Code
**è®¸å¯**: MIT
